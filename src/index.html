<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hop</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõéÔ∏è</text></svg>" />
  <style>
    :root {
      --bg-primary: oklch(23.17% 0.0113 115.0);
      --text-primary: oklch(0.77 0.05 177.41);
      --text-muted: oklch(61.43% 0.0603 149.4);
      --accent-primary: oklch(82.83% 0.0539 158.7);
      --accent-bright: oklch(0.81 0.05 164.12);
      --input-bg: oklch(28.59% 0.0107 114.8);
      --border-color: oklch(34.93% 0.0102 114.7);
      --hover-bg: oklch(40.99% 0.0098 114.6);
      --error-bg: oklch(58.72% 0.1531 28.0);
      --error-text: oklch(73.36% 0.1635 27.9);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      background: var(--bg-primary);
    }

    body {
      font-family: "Courier New", monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2.5rem 1.25rem;
      padding-bottom: 1rem;
      display: flex;
      flex-direction: column;
    }

    .loading-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 0.1875rem;
      background: transparent;
      z-index: 9999;
      overflow: hidden;
    }

    .loading-bar::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, var(--text-muted), var(--accent-primary), var(--accent-bright));
      animation: loading 1.5s ease-in-out infinite;
    }

    body:not(.loading) .loading-bar {
      display: none;
    }

    @keyframes loading {
      0% {
        transform: translateX(-100%);
      }

      50% {
        transform: translateX(0%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    main {
      max-width: 56.25rem;
      margin: 0 auto;
      flex: 1;
      width: 100%;
      min-height: 90vh;
    }

    header {
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text-muted), var(--accent-primary), var(--accent-bright));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.0625rem;
    }

    .subtitle {
      color: var(--text-muted);
      margin-bottom: 1.5rem;
      font-size: 0.8125rem;
      font-family: monospace;
    }

    a {
      color: var(--accent-primary);
      text-decoration: none;
      transition: color 0.15s;
    }

    a:hover {
      color: var(--accent-bright);
      text-decoration: underline;
    }

    a:focus {
      outline: 0.125rem solid var(--accent-primary);
      outline-offset: 0.125rem;
    }

    .shortcut {
      color: var(--text-muted);
      font-size: 0.6875rem;
      margin-bottom: 1rem;
      font-family: monospace;
    }

    .shortcut kbd {
      background: var(--input-bg);
      padding: 0.125rem 0.375rem;
      border-radius: 0.1875rem;
      border: 0.0625rem solid var(--border-color);
      font-size: 0.6875rem;
    }

    .form-section {
      margin-bottom: 2rem;
    }

    .form-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .form-row input[type="url"] {
      flex: 1;
      margin: 0;
    }

    .form-row input[type="text"] {
      width: 8.75rem;
      margin: 0;
    }

    .form-row button {
      width: auto;
      padding: 0.75rem 1.25rem;
      margin: 0;
    }

    input {
      width: 100%;
      padding: 0.75rem 0.875rem;
      background: var(--input-bg);
      border: 0.0625rem solid var(--border-color);
      border-radius: 0.25rem;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: "Courier New", monospace;
      margin-bottom: 0.5rem;
      transition: border-color 0.15s;
    }

    input:focus {
      outline: none;
      border-color: var(--text-muted);
      background: #2d2e28;
    }

    input::placeholder {
      color: var(--hover-bg);
    }

    button {
      width: 100%;
      padding: 0.75rem;
      background: var(--text-muted);
      color: var(--bg-primary);
      border: none;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
      font-family: "Courier New", monospace;
      margin-top: 0.25rem;
      transition: background 0.15s;
    }

    button:hover {
      background: #7a9e80;
    }

    button:active {
      background: #5a7f61;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    button:focus {
      outline: 0.125rem solid var(--accent-primary);
      outline-offset: 0.125rem;
    }

    .result {
      margin-top: 1rem;
      padding: 0.75rem 0.875rem;
      background: var(--input-bg);
      border: 0.0625rem solid var(--border-color);
      border-radius: 0.25rem;
      display: none;
      font-family: "Courier New", monospace;
    }

    .result.show {
      display: block;
    }

    .result.error {
      border-color: var(--error-bg);
      color: var(--error-text);
    }

    .short-url {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .short-url input {
      margin: 0;
      flex: 1;
      color: var(--accent-bright);
      font-weight: 700;
    }

    .copy-btn {
      width: auto;
      padding: 0.75rem 1rem;
      margin: 0;
      background: var(--accent-primary);
    }

    .copy-btn:hover {
      background: var(--accent-bright);
    }

    .table-section {
      margin-top: 3rem;
    }

    .table-header {
      color: var(--text-muted);
      font-size: 0.8125rem;
      margin-bottom: 0.75rem;
      font-weight: 400;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--input-bg);
      border: 0.0625rem solid var(--border-color);
      border-radius: 0.25rem;
      overflow: hidden;
    }

    th,
    td {
      padding: 0.75rem 0.875rem;
      text-align: left;
      border-bottom: 0.0625rem solid var(--border-color);
      font-size: 0.8125rem;
    }

    th {
      background: #252620;
      color: var(--accent-primary);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.6875rem;
      letter-spacing: 0.03125rem;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: #2d2e28;
    }

    .url-cell {
      max-width: 25rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text-primary);
    }

    .short-cell {
      color: var(--accent-bright);
      font-weight: 700;
    }

    .short-cell a {
      color: var(--accent-bright);
      text-decoration: none;
    }

    .short-cell a:hover {
      text-decoration: underline;
    }

    .date-cell {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .actions-cell {
      text-align: right;
    }

    .btn-small {
      padding: 0.375rem 0.75rem;
      font-size: 0.6875rem;
      background: var(--border-color);
      color: var(--accent-primary);
      border: none;
      border-radius: 0.1875rem;
      cursor: pointer;
      font-family: "Courier New", monospace;
      transition: background 0.15s;
      margin-left: 0.25rem;
    }

    .btn-small:hover {
      background: var(--hover-bg);
    }

    .btn-delete {
      color: var(--error-text);
    }

    .btn-delete:hover {
      background: var(--error-bg);
      color: var(--bg-primary);
    }

    .empty {
      text-align: center;
      padding: 2.5rem;
      color: var(--text-muted);
    }

    .loading {
      text-align: center;
      padding: 1.25rem;
      color: var(--text-muted);
    }

    .edit-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .edit-form input {
      margin: 0;
      padding: 0.5rem 0.625rem;
      font-size: 0.75rem;
    }

    .edit-form button {
      margin: 0;
      padding: 0.5rem 0.75rem;
      font-size: 0.6875rem;
      width: auto;
    }

    footer {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-top: auto;
    }
  </style>
</head>

<body class="loading" style="background-color: var(--bg-primary)">
  <div class="loading-bar"></div>
  <main class="container">
    <header>
      <h1>üõéÔ∏è hop</h1>
      <p class="subtitle">// fast url shortener</p>
    </header>

    <section class="form-section">
      <div class="shortcut">
        <kbd>tab</kbd> navigate ‚Ä¢ <kbd>enter</kbd> submit ‚Ä¢
        <kbd>esc</kbd> clear ‚Ä¢ <kbd>cmd+k</kbd> focus
      </div>
      <form id="shortenForm">
        <div class="form-row">
          <input type="url" id="url" placeholder="https://example.com/very/long/url" required autofocus />
          <input type="text" id="slug" placeholder="slug" pattern="[a-zA-Z0-9-_]+" />
          <button type="submit">shorten</button>
        </div>
      </form>
      <div id="result" class="result">
        <div id="resultMessage"></div>
        <div id="shortUrlContainer"></div>
      </div>
    </section>

    <section class="table-section">
      <h2 class="table-header">
        <span>// existing urls</span>
      </h2>
      <div id="urlsTable"></div>
    </section>
  </main>

  <footer>
    <p><span id="urlCount">0 urls</span> ‚Ä¢ <time id="liveTime"></time></p>
    <p>made with ‚ô•Ô∏é by <a href="https://dunkirk.sh">kieran klukas</a></p>
  </footer>

  <script>
    const isReload =
      performance.navigation.type === 1 ||
      performance.getEntriesByType("navigation")[0]?.type === "reload";

    if (isReload) {
      document.body.classList.remove("loading");
      const cached = sessionStorage.getItem("hop_urls");
      if (cached) {
        try {
          const urls = JSON.parse(cached);
          document.getElementById("urlsTable").innerHTML = urls;
        } catch (e) { }
      }
    }

    const form = document.getElementById("shortenForm");
    const result = document.getElementById("result");
    const resultMessage = document.getElementById("resultMessage");
    const shortUrlContainer = document.getElementById("shortUrlContainer");
    const urlInput = document.getElementById("url");
    const slugInput = document.getElementById("slug");
    const urlsTable = document.getElementById("urlsTable");
    let cachedUrls = [];
    let debounceTimer;
    let resultTimeout;

    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        urlInput.focus();
        urlInput.select();
      }
      if (e.key === "Escape") {
        form.reset();
        result.classList.remove("show", "error");
        slugInput.style.borderColor = "var(--border-color)";
        urlInput.focus();
      }
      if (
        (e.key === "c" || e.key === "C") &&
        document.getElementById("shortUrlInput")
      ) {
        if (e.target.tagName !== "INPUT") {
          e.preventDefault();
          copyToClipboard();
        }
      }
    });

    slugInput.addEventListener("input", (e) => {
      clearTimeout(debounceTimer);
      const slug = e.target.value.trim();
      if (!slug) {
        slugInput.style.borderColor = "var(--border-color)";
        return;
      }
      debounceTimer = setTimeout(async () => {
        const exists = cachedUrls.some((item) => item.shortCode === slug);
        if (exists) {
          slugInput.style.borderColor = "var(--error-bg)";
        } else {
          slugInput.style.borderColor = "var(--text-muted)";
        }
      }, 300);
    });

    async function loadUrls() {
      try {
        const response = await fetch("/api/urls");
        const urls = await response.json();
        cachedUrls = urls;
        renderUrls();
        document.body.classList.remove("loading");
      } catch (error) {
        urlsTable.innerHTML = '<div class="empty">failed to load urls</div>';
        document.body.classList.remove("loading");
      }
    }

    function renderUrls() {
      if (cachedUrls.length === 0) {
        urlsTable.innerHTML = '<div class="empty">no urls yet</div>';
        return;
      }

      const urls = [...cachedUrls].sort((a, b) => b.created - a.created);

      let table = urlsTable.querySelector("table");
      if (!table) {
        urlsTable.innerHTML = `
					<table>
						<thead>
							<tr>
								<th>slug</th>
								<th>url</th>
								<th>created</th>
								<th></th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				`;
        table = urlsTable.querySelector("table");
      }

      const tbody = table.querySelector("tbody");
      const existingRows = new Map();
      tbody.querySelectorAll("tr[data-short]").forEach((row) => {
        existingRows.set(row.dataset.short, row);
      });

      const newRows = new Map();
      urls.forEach((item) => {
        const existingRow = existingRows.get(item.shortCode);

        if (existingRow) {
          const urlCell = existingRow.querySelector(".url-cell");
          const dateCell = existingRow.querySelector(".date-cell");

          if (urlCell && urlCell.textContent !== item.url) {
            urlCell.textContent = item.url;
            urlCell.title = item.url;
          }
          if (dateCell) {
            const dateStr = new Date(item.created).toLocaleDateString();
            if (dateCell.textContent !== dateStr) {
              dateCell.textContent = dateStr;
            }
          }

          newRows.set(item.shortCode, existingRow);
        } else {
          const row = document.createElement("tr");
          row.dataset.short = item.shortCode;
          row.innerHTML = `
						<td class="short-cell"><a href="/${item.shortCode}" target="_blank">/${item.shortCode}</a></td>
						<td class="url-cell" title="${item.url}">${item.url}</td>
						<td class="date-cell">${new Date(item.created).toLocaleDateString()}</td>
						<td class="actions-cell">
							<button class="btn-small" onclick="editUrl('${item.shortCode}', '${item.url.replace(/'/g, "\\'")}')">edit</button>
							<button class="btn-small btn-delete" onclick="deleteUrl('${item.shortCode}')">delete</button>
						</td>
					`;
          newRows.set(item.shortCode, row);
        }
      });

      existingRows.forEach((row, shortCode) => {
        if (!newRows.has(shortCode)) {
          row.remove();
        }
      });

      tbody.innerHTML = "";
      urls.forEach((item) => {
        const row = newRows.get(item.shortCode);
        if (row) tbody.appendChild(row);
      });

      sessionStorage.setItem("hop_urls", urlsTable.innerHTML);
      updateUrlCount();
    }

    function updateUrlCount() {
      const count = cachedUrls.length;
      document.getElementById("urlCount").textContent =
        `${count} url${count !== 1 ? "s" : ""}`;
    }

    loadUrls();
    urlInput.addEventListener("focus", () => {
      if (cachedUrls.length === 0) loadUrls();
    });

    function updateLiveTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString("en-US", {hour12: false});
      document.getElementById("liveTime").textContent = timeStr;
    }

    updateLiveTime();
    setInterval(updateLiveTime, 1000);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const url = urlInput.value;
      const slug = slugInput.value;
      const submitBtn = form.querySelector("button");

      submitBtn.disabled = true;
      submitBtn.textContent = "shortening...";
      result.classList.remove("show", "error");

      try {
        const response = await fetch("/api/shorten", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({url, slug: slug || undefined}),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "Failed to shorten URL");
        }

        const shortUrl = window.location.origin + "/" + data.shortCode;

        resultMessage.textContent = "";
        shortUrlContainer.innerHTML = `
					<div class="short-url">
						<input type="text" value="${shortUrl}" readonly id="shortUrlInput">
						<button class="copy-btn" onclick="copyToClipboard()">copy</button>
					</div>
				`;
        result.classList.add("show");

        const shortUrlInput = document.getElementById("shortUrlInput");
        shortUrlInput.select();
        shortUrlInput.focus();

        try {
          await navigator.clipboard.writeText(shortUrl);
        } catch (err) { }

        cachedUrls.unshift({
          shortCode: data.shortCode,
          url: url,
          created: Date.now(),
        });
        renderUrls();

        form.reset();
        slugInput.style.borderColor = "var(--border-color)";

        clearTimeout(resultTimeout);
        resultTimeout = setTimeout(() => {
          result.classList.remove("show");
          urlInput.focus();
        }, 3000);
      } catch (error) {
        resultMessage.textContent = error.message;
        shortUrlContainer.innerHTML = "";
        result.classList.add("show", "error");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "shorten";
      }
    });

    window.copyToClipboard = async () => {
      const input = document.getElementById("shortUrlInput");
      try {
        await navigator.clipboard.writeText(input.value);
        const btn = document.querySelector(".copy-btn");
        const originalText = btn.textContent;
        btn.textContent = "copied";
        setTimeout(() => (btn.textContent = originalText), 2000);
      } catch (err) {
        input.select();
        document.execCommand("copy");
      }
    };

    window.editUrl = (shortCode, currentUrl) => {
      const row = document.querySelector(`tr[data-short="${shortCode}"]`);
      const urlCell = row.querySelector(".url-cell");

      urlCell.innerHTML = `
				<div class="edit-form">
					<input type="url" value="${currentUrl}" id="editInput-${shortCode}" required>
					<button onclick="saveEdit('${shortCode}')">save</button>
					<button onclick="cancelEdit('${shortCode}', '${currentUrl.replace(/'/g, "\\'")}')">cancel</button>
				</div>
			`;

      const input = document.getElementById(`editInput-${shortCode}`);
      input.focus();
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          saveEdit(shortCode);
        } else if (e.key === "Escape") {
          cancelEdit(shortCode, currentUrl);
        }
      });
    };

    window.saveEdit = async (shortCode) => {
      const input = document.getElementById(`editInput-${shortCode}`);
      const newUrl = input.value;

      try {
        const response = await fetch(`/api/urls/${shortCode}`, {
          method: "PUT",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({url: newUrl}),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Failed to update URL");
        }

        const item = cachedUrls.find((u) => u.shortCode === shortCode);
        if (item) item.url = newUrl;
        renderUrls();
      } catch (error) {
        alert(error.message);
      }
    };

    window.cancelEdit = (shortCode, originalUrl) => {
      const row = document.querySelector(`tr[data-short="${shortCode}"]`);
      const urlCell = row.querySelector(".url-cell");
      urlCell.innerHTML = originalUrl;
      urlCell.title = originalUrl;
    };

    window.deleteUrl = async (shortCode) => {
      if (!confirm(`Delete /${shortCode}?`)) return;

      try {
        const response = await fetch(`/api/urls/${shortCode}`, {
          method: "DELETE",
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Failed to delete URL");
        }

        cachedUrls = cachedUrls.filter((u) => u.shortCode !== shortCode);
        renderUrls();
      } catch (error) {
        alert(error.message);
      }
    };
  </script>
</body>

</html>